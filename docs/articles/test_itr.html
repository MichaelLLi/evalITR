<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="evalITR">
<title>Nonparametric statistical tests for treatment heterogeneity and rank consistency across multiple ML algorithms • evalITR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Nonparametric statistical tests for treatment heterogeneity and rank consistency across multiple ML algorithms">
<meta property="og:description" content="evalITR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">evalITR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-user-s-guide">User's Guide</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-user-s-guide">
    <a class="dropdown-item" href="../articles/install.html">Installation</a>
    <a class="dropdown-item" href="../articles/sample_split.html">Sample Splitting</a>
    <a class="dropdown-item" href="../articles/sample_split_caret.html">Sample Splitting with Caret/SuperLearner</a>
    <a class="dropdown-item" href="../articles/cv_single_alg.html">Cross-Validation</a>
    <a class="dropdown-item" href="../articles/cv_multiple_alg.html">Cross-Validation with Multiple Algorithms</a>
    <a class="dropdown-item" href="../articles/user_itr.html">User-Defined ITR</a>
    <a class="dropdown-item" href="../articles/user_itr_algs.html">Compare Estimated and User Defined ITR</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/MichaelLLi/evalITR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Nonparametric statistical tests for treatment heterogeneity and rank consistency across multiple ML algorithms</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MichaelLLi/evalITR/blob/HEAD/vignettes/test_itr.Rmd" class="external-link"><code>vignettes/test_itr.Rmd</code></a></small>
      <div class="d-none name"><code>test_itr.Rmd</code></div>
    </div>

    
    
<p>In practice, machine learning (ML) algorithms may fail to ascertain
heterogeneous treatment effects due to small small sample sizes, high
dimensionality, and arbitrary parameter-tuning. The
<code>test_itr</code> function allows users to empirically validate the
estimates of GATEs under various ML algorithms with statistical testing.
In particular, there are two types of nonparametric statistical tests:
(1) test for across group treatment effects heterogeneity and (2) test
of rank consistency of GATEs. The following provides a description of
each test. The tests are based on the idea that, if an ML algorithm
produces a reasonable scoring rule (achieved by the
<code>estimate_itr</code> function), it is reasonable to expect that (1)
the GATEs across groups are heterogeneous; and (2) the rank ordering of
the GATEs based on their magnitude should be mononotic.</p>
<p>Following the previous examples, we first estimate GATEs using causal
forest (<code>causal forest</code>), Bayesian Additive Regression Trees
(<code>bartc</code>), LASSO (<code>lasso</code>), random forest
(<code>rf</code>) under cross-validation using the
<code>estimate_itr</code> function. We specify the number of groups to
divide the sample into through the <code>ngates</code> argument. By
setting <code>ngates = 5</code> in the example below, we estimate the
heterogeneous impact of small class sizes on students’ writing scores
across 5 groups of students.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(evalITR)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># specify the trainControl method</span></span>
<span><span class="va">fitControl</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span></span>
<span>                           method <span class="op">=</span> <span class="st">"repeatedcv"</span>,</span>
<span>                           number <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                           repeats <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># estimate ITR</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span></span>
<span><span class="va">fit_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_itr.html">estimate_itr</a></span><span class="op">(</span></span>
<span>               treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>               form <span class="op">=</span> <span class="va">user_formula</span>,</span>
<span>               data <span class="op">=</span> <span class="va">star_data</span>,</span>
<span>               trControl <span class="op">=</span> <span class="va">fitControl</span>,</span>
<span>               algorithms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                  <span class="st">"causal_forest"</span>, <span class="co"># from caret</span></span>
<span>                  <span class="st">"bartc"</span>, <span class="co"># from caret</span></span>
<span>                  <span class="st">"lasso"</span>, <span class="co"># from caret </span></span>
<span>                  <span class="st">"rf"</span><span class="op">)</span>, <span class="co"># from caret </span></span>
<span>               budget <span class="op">=</span> <span class="fl">0.2</span>, <span class="co"># 20% budget constraint</span></span>
<span>               n_folds <span class="op">=</span> <span class="fl">5</span>, <span class="co"># 5-fold cross-validation</span></span>
<span>               ngates <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="co"># 5 groups</span></span>
<span><span class="co">#&gt; Evaluate ITR with cross-validation ...</span></span>
<span><span class="co">#&gt; fitting treatment model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting response model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting treatment model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting response model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting treatment model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting response model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting treatment model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting response model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting treatment model via method 'bart'</span></span>
<span><span class="co">#&gt; fitting response model via method 'bart'</span></span>
<span></span>
<span><span class="co"># evaluate ITR</span></span>
<span><span class="va">est_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/evaluate_itr.html">evaluate_itr</a></span><span class="op">(</span><span class="va">fit_cv</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extract GATEs estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est_cv</span><span class="op">)</span><span class="op">$</span><span class="va">GATE</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 8</span></span></span>
<span><span class="co">#&gt;    estimate std.deviation algorithm     group statistic p.value  upper  lower</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>   -<span style="color: #BB0000;">52.3</span>          125.  causal_forest     1   -<span style="color: #BB0000;">0.417</span>   0.677  193.   -<span style="color: #BB0000;">298.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>   -<span style="color: #BB0000;">61.8</span>          109.  causal_forest     2   -<span style="color: #BB0000;">0.568</span>   0.570  151.   -<span style="color: #BB0000;">275.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    22.8           82.6 causal_forest     3    0.275   0.783  185.   -<span style="color: #BB0000;">139.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   135.           120.  causal_forest     4    1.13    0.259  369.    -<span style="color: #BB0000;">99.3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   -<span style="color: #BB0000;">24.9</span>          124.  causal_forest     5   -<span style="color: #BB0000;">0.202</span>   0.840  217.   -<span style="color: #BB0000;">267.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   -<span style="color: #BB0000;">24.1</span>           88.2 bartc             1   -<span style="color: #BB0000;">0.273</span>   0.785  149.   -<span style="color: #BB0000;">197.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   -<span style="color: #BB0000;">25.5</span>           59.5 bartc             2   -<span style="color: #BB0000;">0.429</span>   0.668   91.1  -<span style="color: #BB0000;">142.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   -<span style="color: #BB0000;">46.9</span>          101.  bartc             3   -<span style="color: #BB0000;">0.465</span>   0.642  151.   -<span style="color: #BB0000;">245.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   131.           102.  bartc             4    1.28    0.199  330.    -<span style="color: #BB0000;">68.7</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   -<span style="color: #BB0000;">15.1</span>          116.  bartc             5   -<span style="color: #BB0000;">0.130</span>   0.896  212.   -<span style="color: #BB0000;">242.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>   -<span style="color: #BB0000;">56.5</span>           92.0 lasso             1   -<span style="color: #BB0000;">0.614</span>   0.539  124.   -<span style="color: #BB0000;">237.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    98.6           59.5 lasso             2    1.66    0.097<span style="text-decoration: underline;">5</span> 215.    -<span style="color: #BB0000;">18.0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>   -<span style="color: #BB0000;">25.6</span>          114.  lasso             3   -<span style="color: #BB0000;">0.224</span>   0.823  199.   -<span style="color: #BB0000;">250.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    40.4          117.  lasso             4    0.344   0.731  271.   -<span style="color: #BB0000;">190.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>   -<span style="color: #BB0000;">38.0</span>           96.8 lasso             5   -<span style="color: #BB0000;">0.393</span>   0.695  152.   -<span style="color: #BB0000;">228.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>  -<span style="color: #BB0000;">117.</span>            58.7 rf                1   -<span style="color: #BB0000;">1.99</span>    0.046<span style="text-decoration: underline;">9</span>  -<span style="color: #BB0000;">1.61</span> -<span style="color: #BB0000;">232.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>     2.78         124.  rf                2    0.022<span style="text-decoration: underline;">4</span>  0.982  246.   -<span style="color: #BB0000;">240.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    22.7          111.  rf                3    0.204   0.838  241.   -<span style="color: #BB0000;">196.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>   145.            94.6 rf                4    1.53    0.125  331.    -<span style="color: #BB0000;">40.3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>   -<span style="color: #BB0000;">35.0</span>          118.  rf                5   -<span style="color: #BB0000;">0.296</span>   0.767  197.   -<span style="color: #BB0000;">267.</span></span></span></code></pre></div>
<p>The table reports the quintile GATEs (<span class="math inline">\(K =
5\)</span>) estimates for each ML algorithm. We find that the Random
Forest is able to produce statistically negative GATE for the lowest
quantitle group (group 1) under cross-validation. This provides evidence
that the Random Forest is able to identify a 20% subgroup whose writing
scores are negatively impacted by small class sizes.</p>
<p>We now conduct the statistical tests of treatment effect
heterogeneity and rank consistency to validate these GATEs estimates. We
use the module object output <code>test_est_cv</code> from the
<code>evaluate_itr</code> function as the input object for the
<code>test_itr</code> function to conduct 2 tests simultaneously. We can
summarize the test statistics and the p-values using the
<code>summary</code> function. Lastly, we use the <code>nsims</code>
argument to specify the number of simulations to conduct for each test.
The default is 1000 simulations.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># conduct nonparametric tests</span></span>
<span><span class="va">test_est_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_itr.html">test_itr</a></span><span class="op">(</span><span class="va">est_cv</span>,</span>
<span>                        nsim <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Conduct hypothesis tests for GATEs unde cross-validation ...</span></span>
<span></span>
<span><span class="co"># summarize test statistics and p-values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">test_est_cv</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── The Consistency Test Results for GATEs ──────────────────────────────────────</span></span>
<span><span class="co">#&gt; No consistency results available (sample-splitting).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── The Heterogeneity Test Results for GATEs ────────────────────────────────────</span></span>
<span><span class="co">#&gt; No heterogeneity results available (sample-splitting).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── The Consistency Test Results for GATEs (Cross-validation) ───────────────────</span></span>
<span><span class="co">#&gt;       algorithm statistic p.value</span></span>
<span><span class="co">#&gt; 1 causal_forest      0.83    0.74</span></span>
<span><span class="co">#&gt; 2         bartc      1.03    0.63</span></span>
<span><span class="co">#&gt; 3         lasso      0.24    0.82</span></span>
<span><span class="co">#&gt; 4            rf      1.32    0.66</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── The Heterogeneity Test Results for GATEs (Cross-validation) ─────────────────</span></span>
<span><span class="co">#&gt;       algorithm statistic p.value</span></span>
<span><span class="co">#&gt; 1 causal_forest       1.9    0.86</span></span>
<span><span class="co">#&gt; 2         bartc       2.3    0.81</span></span>
<span><span class="co">#&gt; 3         lasso       3.3    0.65</span></span>
<span><span class="co">#&gt; 4            rf       6.6    0.25</span></span></code></pre></div>
<p>The table reports the resulting values of test statistics and the
p-values for each test under each algorithm. We find that none of the ML
algorithms is able to reject the treatment effect homogeneity hypothesis
under cross-validation, which indicates that these algorithms failed to
identify statistically significant GATEs estimate for any subgroup. In
addition, none of the ML algorithms is able to reject the rank
consistency hypothesis under cross-validation. Thus, there is no strong
statistical evidence that these algorithms are producing unreliable
GATEs.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Lingzhi Li, Kosuke Imai.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
